<?xml version="1.0"?>
<launch>
  <!-- 1. Map Server: Loads your pre-saved map -->
  <node pkg="map_server" type="map_server" name="map_server"
        args="$(find sick_scan_xd)/maps/r_lab2.yaml"
        output="screen" />
    
  <!-- 2. AMCL Node -->
  <node pkg="amcl" type="amcl" name="amcl" output="screen">


    <!-- Frames -->
    <param name="global_frame_id" value="map"/>
    <param name="odom_frame_id"   value="odom"/>
    <param name="base_frame_id"   value="base_link"/>

    <!-- Laser Scan -->
    <param name="scan_topic" value="/scan"/>

    <!-- Particle Filter & Sensor Model -->
    <param name="min_particles"      value="300"/>
    <param name="max_particles"      value="1500"/>
    <param name="kld_err"            value="0.02"/>
    <param name="kld_z"              value="0.99"/>

    <!-- Laser Params -->
    <param name="laser_min_range"            value="0.05"/>
    <param name="laser_max_range"            value="10.0"/>
    <param name="laser_likelihood_max_dist"  value="0.5"/>

    <!-- Update Thresholds (movement needed before update) -->
    <param name="update_min_d"   value="0.2"/>
    <param name="update_min_a"   value="0.2"/>

    <!-- Odom Noise (tuned for minimal noise if you have decent odometry) -->
    <param name="odom_alpha1" value="0.00000001"/>
    <param name="odom_alpha2" value="0.00000001"/>
    <param name="odom_alpha3" value="0.00000001"/>
    <param name="odom_alpha4" value="0.00000001"/>
    <param name="odom_alpha5" value="0.00000001"/>

    <!-- Additional Sensor Model Parameters -->
    <param name="sigma_hit"    value="0.1"/>
    <param name="lambda_short" value="0.05"/>
    <param name="z_hit"        value="0.9"/>
    <param name="z_short"      value="0.05"/>
    <param name="recovery_alpha_slow" value="0.0"/>
    <param name="recovery_alpha_fast" value="0.0"/>

    <!-- Initial Pose -->
    <param name="initial_pose_x"   value="0.0"/>
    <param name="initial_pose_y"   value="0.0"/>
    <param name="initial_pose_a"   value="0.0"/>
    <param name="initial_cov_xx"   value="0.01"/>
    <param name="initial_cov_yy"   value="0.01"/>
    <param name="initial_cov_aa"   value="0.005"/>

    <!-- Debug Logging -->
    <param name="log_level" value="debug"/>
  </node>

  <!-- 3. RViz for Visualization -->
  <node pkg="rviz" type="rviz" name="rviz"
        args="-d $(find sick_scan_xd)/rviz/amcl_config.rviz"
        output="screen" />

  <!-- 4. TF Publishers -->
  <!-- Ensure map is correctly linked to base_link via odom -->
  <node pkg="tf" type="static_transform_publisher" name="map_to_odom"
        args="0 0 0 0 0 0 map odom 100" />

  <!-- ðŸš€ Removed static transform for odom -> base_link, as your robot must publish this dynamically -->

  <!-- Example: base_link -> cloud_POS_000_DIST1 -->
  <node pkg="tf" type="static_transform_publisher" name="static_transform_cloud_pos_000"
        args="0 0 0 0 0 0 base_link cloud_POS_000_DIST1 100" />

  <!-- If you also have other frames: -->
  <node pkg="tf" type="static_transform_publisher" name="static_transform_cloud_pos_250"
        args="0 0 0 0 0 0 base_link cloud_POS_250_DIST1 100" />
  <node pkg="tf" type="static_transform_publisher" name="static_transform_cloud_neg_250"
        args="0 0 0 0 0 0 base_link cloud_NEG_250_DIST1 100" />
  <node pkg="tf" type="static_transform_publisher" name="static_transform_cloud_neg_500"
        args="0 0 0 0 0 0 base_link cloud_NEG_500_DIST1 100" />

  <!-- If you also use a separate base_laser frame: -->
  <node pkg="tf" type="static_transform_publisher" name="base_laser_to_base_link"
        args="0 0 0 0 0 0 1 base_link base_laser 100" />
  <node pkg="tf" type="static_transform_publisher" name="laserscan_layer_0_base_laser"
        args="0 0 0 0 0 0 1 base_laser cloud_POS_000_DIST1 100" />
</launch>
